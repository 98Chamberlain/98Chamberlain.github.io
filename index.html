<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <title>分年細目視覺化</title>
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/vis/4.21.0/vis.min.js"></script>
        <link href="https://cdnjs.cloudflare.com/ajax/libs/vis/4.21.0/vis.min.css" rel="stylesheet" type="text/css" />
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.js"></script>
        <!-- bootstrap -->
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/css/bootstrap.min.css" integrity="sha384-PsH8R72JQ3SOdhVi3uxftmaW6Vc51MKb0q5P2rRUpPvrszuE4W1povHYgTpBfshb" crossorigin="anonymous">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.3/umd/popper.min.js" integrity="sha384-vFJXuSJphROIrBnz7yo7oB41mKfc8JzQZiCq4NCceLEaO4IHwicKwpJf9c9IpFgh" crossorigin="anonymous"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/js/bootstrap.min.js" integrity="sha384-alpBpkh1PFOepccYVYDB4do5UnbKysX5WZXm3XxPqe5iKTfUKjNkCk9SaVuEZflJ" crossorigin="anonymous"></script>
        <!-- filesaver -->
        <script src="https://fastcdn.org/FileSaver.js/1.1.20151003/FileSaver.js"></script>

        <style type="text/css">
            #cg_network {
                width: 95vw;
                height: 90vh;
                border: 1px solid lightgray;
            }
            .dropdown, input, #editModeBtn {
                display: inline-block;
                margin: 10px;
            }
            .result-dropdown-container, #red_edge {
                display: inline-block;
            }
            #studentDropdownContainer, #dateDropdownContainer {
                max-height: 80vh;
                overflow-y: scroll;
            }
            .radio-color-display {
                width: 15px;
                height: 15px;
                display: inline-block;
                margin-right: 5px;
                border: 1px black solid;
                vertical-align: middle;
            }
            .start-point-container {
                float: right;
                margin-right: 5vw;
            }
        </style>
        <script>
            // constant setting
            var curEmail = undefined;
            var curTime = undefined;
            var results_obj = undefined;
            var junyi_obj = undefined;
            var fraction_cg = ["3-n-11","4-n-07","4-n-08","4-n-09","4-n-10",
                               "5-n-06","5-n-07","5-n-08","5-n-09","5-n-13",
                               "6-n-03","6-n-04","6-n-05","6-n-09","6-n-10"];
            var cgToExercise = {
                "3-n-11": ["menfs3ce"],
                "4-n-07": [],
                "4-n-08": ["menfs4cb","menfs4ab"],
                "4-n-09": [],
                "4-n-10": [],
                "5-n-06": ["menfs4ae"],
                "5-n-07": ["menfs5ba"],
                "5-n-08": ["m3afs-cd"],
                "5-n-09": ["m3afs-ch"],
                "5-n-13": ["mencs5ci"],
                "6-n-03": ["menzs6af","menzs6aj"],
                "6-n-04": ["menfs6ak"],
                "6-n-05": ["menfs6ag"],
                "6-n-09": ["menfs6bc"],
                "6-n-10": ["m3abs-ca"],
            }
            var notvalidWeight = [
                    [0., 0, 0, 0, 0, 0.12568306, 0.15766739, 0.34773218, 0.25161987, 0.15658747, 0.39441341, 0.29273743, 0.11396648, 0.1575419, 0.18435754,],
                    [0, 0., 0.05201178, 0.13735178, 0.11688312, 0.14920949, 0.14130435, 0.19960474, 0.1916996, 0.32509881, 0.02826511, 0.09259259, 0.00779727, 0.10721248, 0.05354752,],
                    [0, 0.17369971, 0., 0.06324111, 0.21478521, 0.07509881, 0.06818182, 0.09486166, 0.09782609, 0.16205534, 0.13060429, 0.35575049, 0.06725146, 0.42202729, 0.20749665,],
                    [0, 0.35474308, 0.08300395, 0., 0.27173913, 0.23418972, 0.22529644, 0.30039526, 0.28162055, 0.49901186, 0, 0, 0, 0, 0,],
                    [0, 0.1978022, 0.1028971, 0.16304348, 0., 0.1916996, 0.1798419, 0.24901186, 0.23418972, 0.41501976, 0.1010101, 0.24545455, 0.03535354, 0.29292929, 0.14486639,],
                    [0.02076503, 0.33794466, 0.09288538, 0.2055336, 0.27173913, 0., 0.19763514, 0.38344595, 0.30658784, 0.31883446, 0.52318393, 0.40108192, 0.16151468, 0.20401855, 0.23879444,],
                    [0.0237581, 0.32608696, 0.08596838, 0.19268775, 0.25592885, 0.16089527, 0., 0.35340532, 0.27574751, 0.31436877, 0.47976012, 0.37331334, 0.13568216, 0.1934033, 0.22563718,],
                    [0.0075594, 0.26284585, 0.05731225, 0.14624506, 0.20355731, 0.09839527, 0.10548173, 0., 0.15033223, 0.20182724, 0.19415292, 0.13793103, 0.05922039, 0.05997001, 0.08170915,],
                    [0.02159827, 0.28458498, 0.08399209, 0.15711462, 0.21837945, 0.13302365, 0.13870432, 0.26121262, 0., 0.24335548, 0.33208396, 0.24137931, 0.10194903, 0.13418291, 0.15517241,],
                    [0.02051836, 0.09288538, 0.02272727, 0.04940711, 0.07411067, 0.10726351, 0.13496678, 0.27034884, 0.20099668, 0., 0.46326837, 0.34632684, 0.13718141, 0.17841079, 0.22113943,],
                    [0.00782123, 0.06335283, 0.07212476, 0, 0.12222222, 0.05255023, 0.06521739, 0.12743628, 0.09295352, 0.05997001, 0., 0.10639938, 0.02235929, 0.0844256, 0.07559395,],
                    [0.01452514, 0.14230019, 0.13840156, 0, 0.21515152, 0.08423493, 0.1131934, 0.22563718, 0.15667166, 0.09745127, 0.16499614, 0, 0.04548959, 0.16576715, 0.12440605,],
                    [0.00782123, 0.04678363, 0.05945419, 0, 0.0979798, 0.06877898, 0.06746627, 0.17916042, 0.12743628, 0.08245877, 0.11063994, 0.11295297, 0., 0.08211257, 0.08509719,],
                    [0.00893855, 0.09356725, 0.10233918, 0, 0.15757576, 0.05332303, 0.06746627, 0.15292354, 0.11769115, 0.06146927, 0.10717039, 0.1464919, 0.02698535, 0., 0.09287257,],
                    [0.01899441, 0.18206158, 0.18607764, 0, 0.30098453, 0.17928903, 0.22038981, 0.42428786, 0.32533733, 0.22713643, 0.31274298, 0.35680346, 0.10410367, 0.27343413, 0.,]]
            var cgNodeList = [
                { id: '3-n-11', label: '3-n-11\n認識分數、同分母比較/加減', name: '3-n-11\n認識分數、同分母比較/加減', cg: '3-n-11' },
                { id: '4-n-07', label: '4-n-07\n整數相除的意涵', name: '4-n-07\n整數相除的意涵', cg: '4-n-07' },
                { id: '4-n-08', label: '4-n-08\n真分數、假分數與帶分數', name: '4-n-08\n真分數、假分數與帶分數', cg: '4-n-08' },
                { id: '4-n-09', label: '4-n-09\n等值分數、異分母分數比較', name: '4-n-09\n等值分數、異分母分數比較', cg: '4-n-09' },
                { id: '4-n-10', label: '4-n-10\n分數標記在數線', name: '4-n-10\n分數標記在數線', cg: '4-n-10' },
                { id: '5-n-06', label: '5-n-06\n約分、擴分、等值分數', name: '5-n-06\n約分、擴分、等值分數', cg: '5-n-06' },
                { id: '5-n-07', label: '5-n-07\n通分、異分母分數比較/加減', name: '5-n-07\n通分、異分母分數比較/加減', cg: '5-n-07' },
                { id: '5-n-08', label: '5-n-08\n分數乘法', name: '5-n-08\n分數乘法', cg: '5-n-08' },
                { id: '5-n-09', label: '5-n-09\n除數為整數的分數除法', name: '5-n-09\n除數為整數的分數除法', cg: '5-n-09' },
                { id: '5-n-13', label: '5-n-13\n分數、小數標記在數線', name: '5-n-13\n分數、小數標記在數線', cg: '5-n-13' },
                { id: '6-n-03', label: '6-n-03\n將分數約成最簡分數', name: '6-n-03\n將分數約成最簡分數', cg: '6-n-03' },
                { id: '6-n-04', label: '6-n-04\n分數除法', name: '6-n-04\n分數除法', cg: '6-n-04' },
                { id: '6-n-05', label: '6-n-05\n分數的兩步驟問題', name: '6-n-05\n分數的兩步驟問題', cg: '6-n-05' },
                { id: '6-n-09', label: '6-n-09\n認識比和比值', name: '6-n-09\n認識比和比值', cg: '6-n-09' },
                { id: '6-n-10', label: '6-n-10\n理解正比的意義', name: '6-n-10\n理解正比的意義', cg: '6-n-10' },
            ];

            // yisheng
            var cgYishengList = [
                { from: '4-n-08', to: '4-n-07' },
                { from: '3-n-11', to: '4-n-08' },
                { from: '4-n-08', to: '4-n-09' },
                { from: '4-n-07', to: '4-n-09' },
                { from: '4-n-07', to: '4-n-10' },
                { from: '4-n-09', to: '4-n-10' },
                { from: '4-n-09', to: '5-n-06' },
                { from: '5-n-04', to: '5-n-06' },
                { from: '5-n-06', to: '5-n-07' },
                { from: '5-n-04', to: '5-n-07' },
                { from: '5-n-05', to: '5-n-07' },
                { from: '4-n-07', to: '5-n-08' },
                { from: '5-n-06', to: '5-n-08' },
                { from: '5-n-08', to: '5-n-09' },
                { from: '4-n-10', to: '5-n-13' },
                { from: '5-n-06', to: '6-n-03' },
                { from: '6-n-02', to: '6-n-03' },
                { from: '5-n-09', to: '6-n-04' },
                { from: '5-n-06', to: '6-n-09' },
                { from: '5-n-14', to: '6-n-09' },
                { from: '6-n-09', to: '6-n-10' }
            ];
            cgYishengList = updateEdgesWeight(cgYishengList);

            // inChai
            var cgInchaiList = [
                { from: '3-n-11', to: '4-n-07' },
                { from: '3-n-11', to: '4-n-09' },
                { from: '3-n-11', to: '4-n-08' },
                { from: '4-n-08', to: '4-n-10' },
                { from: '4-n-09', to: '5-n-06' },
                { from: '5-n-06', to: '5-n-07' },
                { from: '4-n-08', to: '5-n-07' },
                { from: '4-n-08', to: '5-n-08' },
                { from: '4-n-08', to: '5-n-09' },
                { from: '4-n-10', to: '5-n-13' },
                { from: '6-n-09', to: '6-n-10' }
            ];
            cgInchaiList = updateEdgesWeight(cgInchaiList); 
            
            function updateEdgesWeight(edges_list){
                for(var i=0; i < edges_list.length; i++){
                    edge = edges_list[i];
                    from = edge['from'];
                    to = edge['to'];
                    ind1 = fraction_cg.indexOf(from);
                    ind2 = fraction_cg.indexOf(to);
                    if (ind1>=0 && ind2>=0){
                        weight = notvalidWeight[ind1][ind2];
                        if (weight > 0){
                            edges_list[i]['width'] = (1-weight) * 8;
                        }
                    }
                }
                return edges_list
            }

            function cgToSection(cg){
                var exerciseList = cgToExercise[cg] || [];
                var sectionList = []
                for(var idx=0; idx<exerciseList.length; idx++){
                    sectionName = exToSection(exerciseList[idx]);
                    if (sectionName){
                        sectionList.push(sectionName);
                    }
                }
                if (sectionList.length === 0){
                    var cgFilterNodeList = curNodeList.filter(function(node){
                        return node["cg"] === cg
                    });
                    sectionList = cgFilterNodeList.map(function(node){
                        return node["id"]
                    });
                }
                return sectionList;
            }
            function exToSection(exId){
                filterExercise = liveExercise.filter(function(exercise){
                    return exercise["content_id"] === exId
                });
                sectionName = "";
                for(var i=0; i<filterExercise.length; i++){
                    chapter = filterExercise[i]["chapter_title"];
                    section = filterExercise[i]["section_title"];
                    sectionName = chapter+"_"+section;
                }
                return [sectionName]
            }
            function exToCg(ex_id) {
                filterExercise = liveExercise.filter(function (exercise) {
                    return exercise["content_id"] === ex_id
                });
                cgName = [];
                for (var i = 0; i < filterExercise.length; i++) {
                    cg_id = filterExercise[i]["curriculum_guideline_id"];
                    if (cgName.indexOf(cg_id) === -1){
                        cgName.push(cg_id);
                    }
                }
                return cgName
            }
            function getExName(exId){
                filterExercise = liveExercise.filter(function(exercise){
                    return exercise["content_id"] === exId
                });
                exerciseName = "";
                for(var i=0; i<filterExercise.length; i++){
                    exerciseName = filterExercise[i]["content_title"];
                    break;
                }
                return exerciseName
            }

            function changeEdgeColor(student_result, edges_list){
                var ret_edges_list = jQuery.extend(true, [], edges_list);
                var red_edge = 0;
                for(var i = 0; i < edges_list.length; i++){
                    edge = edges_list[i];
                    from = edge['from'];
                    to = edge['to'];
                    if(student_result[from] && student_result[to]){
                        if(student_result[from]['status']==='X' && student_result[to]['status']==='O'){    
                            ret_edges_list[i]['color'] = {color: 'red', highlight: 'red'};
                            red_edge += 1;
                        } else{
                            ret_edges_list[i]['color'] = undefined;
                        }
                    } else {
                        ret_edges_list[i]['color'] = {color: '#CCC', highlight: '#CCC'};
                    }
                }
                $("#red_edge")[0].innerHTML = "有 " + red_edge + " 條錯誤連線";
                return ret_edges_list
            }

            function loadJson(data){
                if (!data){
                    data = $("#cg_result")[0].value;
                }
                results_obj = jQuery.parseJSON(data);
                $(".submit_junyi").show();
                //junyi_obj = undefined;
                //updateStudentDropdown();
            }
            function loadJunyiJson(data){
                if(!data){
                    data = $("#junyi_result")[0].value;
                }
                junyi_obj = jQuery.parseJSON(data);
                updateStudentDropdown();
            }
            function updateStudentDropdown(){
                // if (!results_obj){
                //     return
                // }
                var student_list = [];
                var studentDropdown = $("#studentDropdownContainer");
                studentDropdown[0].innerHTML = "";
                // for(var email in results_obj){
                //     student_list.push(email);
                //     var s_item = $("<a></a>").text(email);
                //     s_item.attr("class", "dropdown-item");
                //     s_item.attr("id", email);
                //     s_item.attr("value", email);
                //     s_item.attr("onclick", "setEmail(this.id)");
                //     studentDropdown.append(s_item)
                // }
                if(junyi_obj){
                    for(var email in junyi_obj){
                        if(student_list.indexOf(email) === -1){
                            student_list.push(email);
                            var s_item = $("<a></a>").text(email);
                            s_item.attr("class", "dropdown-item");
                            s_item.attr("id", email);
                            s_item.attr("value", email);
                            s_item.attr("onclick", "setEmail(this.id)");
                            studentDropdown.append(s_item)
                        }
                    }
                }
                $("#dropdownStudentButton").removeAttr("disabled")
                $("#dropdownStudentButton")[0].innerHTML = "選擇學生";
            }
            function updateDateDropdown(){
                if(!results_obj){
                    alert("沒有載入測驗結果。");
                    return;
                }
                var result_obj = results_obj[curEmail];
                var date_list = [];
                for(var cg in result_obj){
                    cg_obj = result_obj[cg];
                    if( Array.isArray(cg_obj) ){
                        for(var i=0; i< cg_obj.length; i++){
                            d = cg_obj[i]['date'];
                            if( date_list.indexOf(d) === -1 ){
                                date_list.push(d);
                            }
                        }
                    } else {
                        d = cg_obj['date'];
                        if( date_list.indexOf(d) === -1 ){
                            date_list.push(d);
                        }
                    }
                }
                var dateDropdown = $("#dateDropdownContainer");
                dateDropdown[0].innerHTML = "<a class=\"dropdown-item\" id=\"all\" value=\"all\" onclick=\"changeNodeGroup(this.id)\">所有時間</a>";
                for(var idx=0; idx<date_list.length; idx++){
                    d = date_list[idx];
                    var d_item = $("<a></a>").text(d);
                    d_item.attr("class", "dropdown-item");
                    d_item.attr("id", d);
                    d_item.attr("value", d);
                    d_item.attr("onclick", "changeNodeGroup(this.id)");
                    dateDropdown.append(d_item)
                }
                $("#dropdownDateButton").removeAttr("disabled");
            }
            function setEmail(email){
                if(!email){ return }

                curEmail = email;
                curTime = 'all';
                updateDateDropdown();
                changeNodeGroup(curTime);
                $("#dropdownStudentButton")[0].innerHTML = email;
            }
            function getRemedialResultByTime(time){
                var remedial_result_tmp = results_obj[curEmail];
                if (!remedial_result_tmp) {remedial_result_tmp = {};}
                var remedial_result = {};
                // 整理obj
                if (time == 'all'){
                    for(var cg in remedial_result_tmp){
                        if (!CgLevel){
                            sectionList = cgToSection(cg);
                        } else {
                            sectionList = [cg];
                        }
                        cg_obj = remedial_result_tmp[cg];
                        if( Array.isArray(cg_obj) ){
                            max_status = "";
                            max_date = "";
                            for(var i=0; i< cg_obj.length; i++){
                                if (!max_status & !max_date){
                                    max_status = cg_obj[i]['status'];
                                    max_date = cg_obj[i]['date'];
                                } else {
                                    this_status = cg_obj[i]['status'];
                                    if (this_status < max_status){ 
                                        // because O < T < X
                                        max_status = cg_obj[i]['status'];
                                        max_date = cg_obj[i]['date'];
                                    }
                                }
                            }
                            for(var i=0; i<sectionList.length; i++){
                                section = sectionList[i];
                                remedial_result[section] = {
                                    'status': max_status,
                                    'date': max_date,
                                }
                            }
                        } else {
                            if(!cg_obj['status']){
                                for(var i=0; i<sectionList.length; i++){
                                    section = sectionList[i];
                                    remedial_result[section] = {
                                        'status': cg_obj,
                                        'date': "NA",
                                    };
                                }
                            } else {
                                for(var i=0; i<sectionList.length; i++){
                                    section = sectionList[i];
                                    remedial_result[section] = cg_obj;
                                }
                            }
                        }
                    }
                } else {
                    for(var cg in remedial_result_tmp){
                        if (!CgLevel){
                            sectionList = cgToSection(cg);
                        } else {
                            sectionList = [cg];
                        }
                        cg_obj = remedial_result_tmp[cg];
                        if( Array.isArray(cg_obj) ){
                            for(var i=0; i< cg_obj.length; i++){
                                if(cg_obj[i]['date'] === time){
                                    for(var j=0; j<sectionList.length; j++){
                                        section = sectionList[j];
                                        remedial_result[section] = cg_obj[i];
                                    }
                                    break;
                                }
                            }
                        } else {
                            if(cg_obj['date'] === time){
                                for(var j=0; j<sectionList.length; j++){
                                    section = sectionList[j];
                                    remedial_result[section] = cg_obj;
                                }
                            }
                        }
                    }
                }
                $("#dropdownDateButton")[0].innerHTML = time==='all' ? "所有時間" : time ;
                return remedial_result
            }
            function getJunyiResult(){
                if (!junyi_obj){
                    return {};
                }
                student_in_jy = junyi_obj[curEmail];
                if (!student_in_jy){ student_in_jy = {}; }
                var junyi_result = {};
                var section_result = {}
                for (var ex_id in student_in_jy){
                    ex_result = student_in_jy[ex_id];
                    ex_result["title"] = getExName(ex_id);
                    var sectionNameList = CgLevel ? exToCg(ex_id) : exToSection(ex_id);
                    for(var sec_idx=0; sec_idx < sectionNameList.length; sec_idx++){
                        var sectionName = sectionNameList[sec_idx];
                        if (!(sectionName in section_result)) {
                            section_result[sectionName] = [];
                        }
                        section_result[sectionName].push(ex_result);
                    }
                }
                for(var sectionName in section_result){
                    junyi_result[sectionName] = summaryResult(section_result[sectionName])
                }
                return junyi_result
            }
            function summaryResult(resultList){
                desc = [];
                status = "";
                count = {
                    "under5": 0,
                    "easy": 0,
                    "fit": 0,
                    "not_fit": 0,
                };
                status_word = {
                    "under5": "還沒等級一",
                    "easy": "已經會了",
                    "fit": "學會",
                    "not_fit": "不適合",
                };
                for (var i=0; i<resultList.length; i++){
                    result = resultList[i];
                    count[ result["status"] ] += 1;
                    desc.push( result["date"]+'  '+result["title"] +'  '+status_word[ result["status"] ] );
                }
                desc = desc.join('\n');
                max_count = 0;
                for (var s in count){
                    if(count[s] >= max_count){
                        max_count = count[s];
                        status = s;
                    }
                }
                return {
                    "status": status,
                    "date": desc,
                }
            }
            function mergeTwoResult( remedial_result, junyi_result){
                var result_obj = jQuery.extend(true, {}, remedial_result);
                for(var sectionName in junyi_result){
                    if(!(sectionName in remedial_result)){
                        result_obj[sectionName] = junyi_result[sectionName];
                    } else {
                        // handle the conflict status
                        if ((remedial_result[sectionName]['status'] === 'O' && junyi_result[sectionName]['status'] === 'not_fit') ||
                            (remedial_result[sectionName]['status'] === 'X' && 
                                (junyi_result[sectionName]['status'] === 'easy' || junyi_result[sectionName]['status'] === 'fit'))){
                            result_obj[sectionName]['status'] = 'conflict';
                        }
                        // combine the date
                        if (remedial_result[sectionName]['date'] !== 'NA' || remedial_result[sectionName]['date'] !== 'nan'){
                            result_obj[sectionName]['date'] = remedial_result[sectionName]['date'] + ' 補救結果：' + remedial_result[sectionName]['status'] + '\n' + junyi_result[sectionName]['date'];
                        } else {
                            result_obj[sectionName]['date'] = '補救結果：'+ remedial_result[sectionName]['status']+'\n'+junyi_result[sectionName]['date'];
                        }
                        
                    }
                }
                return result_obj
            }
            function changeNodeGroup(time){
                if(!time){
                    time = 'all';
                }
                if(!curEmail){
                    alert("沒有選擇學生！")
                    return;
                }
                var remedial_result = getRemedialResultByTime(time);
                var junyi_result = onlyRemedialResult ? {} : getJunyiResult();
                var result_obj = mergeTwoResult(remedial_result, junyi_result);
                var nodeListTmp = jQuery.extend(true, [], curNodeList);
                for(var i = 0; i < nodeListTmp.length; i++){
                    node_obj = nodeListTmp[i];
                    node_id = node_obj['id'];
                    if (node_id in result_obj){
                        if (result_obj[node_id]['status']){
                            nodeListTmp[i]['group'] = result_obj[ node_id ]['status'];
                            if (result_obj[node_id]['date'] !== 'NA' && result_obj[node_id]['date'] !== 'nan'){
                                nodeListTmp[i]['label'] = nodeListTmp[i]['name']+'\n'+result_obj[node_id]['date'];
                            } else {
                                nodeListTmp[i]['label'] = nodeListTmp[i]['name'];
                            }
                        } else{
                            nodeListTmp[i]['group'] = result_obj[ node_id ];
                            nodeListTmp[i]['label'] = nodeListTmp[i]['name'];
                        }
                    } else{
                        nodeListTmp[i]['group'] = undefined;
                        nodeListTmp[i]['label'] = nodeListTmp[i]['name'];
                    }
                }
                curNodeList = jQuery.extend(true, [], nodeListTmp);
                curEdgeList = changeEdgeColor(result_obj, curEdgeList);
                setAndRedrawNetwork();
            }
            function getStartNode(_curNodeList, _curEdgeList){
                var startNodeList = [];
                for (var i = 0; i< _curEdgeList.length; i++){
                    var edgeObj = _curEdgeList[i];
                    var fromNode = edgeObj['from'];
                    var filterEdgeList = _curEdgeList.filter(function(edge){
                        return edge['to'] === fromNode
                    });
                    if(filterEdgeList.length === 0){
                        if(startNodeList.indexOf(fromNode) === -1){
                            startNodeList.push(fromNode);
                        }
                    }
                }
                // handle the lonely island
                for (var i = 0; i<_curNodeList.length; i++){
                    var nodeObj = _curNodeList[i];
                    var nodeId = nodeObj['id'];
                    var filterEdgeList = _curEdgeList.filter(function(edge){
                        return edge['from'] === nodeId || edge['to'] === nodeId
                    });
                    if(filterEdgeList.length === 0){
                        if (startNodeList.indexOf(nodeId) === -1) {
                            startNodeList.push(nodeId);
                        }
                    }
                }
                return startNodeList
            }
            function getNodeById(nodeId, _curNodeList) {
                var matchNode = _curNodeList.filter(function (node) {
                    return node['id'] === nodeId
                });
                if (matchNode.length === 0) {
                    return {}
                } else {
                    return matchNode[0]
                }
            }
            function recursiveFindStartPoint(curStartNodeIdList, _curNodeList, _curEdgeList, statusList, checkCurNode){
                
                var matchedNodeList = [];
                if(checkCurNode){
                    var curNodeList = curStartNodeIdList.map(function(nodeId){
                        return getNodeById(nodeId, _curNodeList)
                    });
                    for (var i=0; i<curNodeList.length; i++){
                        var curNodeObj = curNodeList[i];
                        if (statusList.indexOf(curNodeObj['group']) >= 0) {
                            matchedNodeList.push(curNodeObj);
                        }
                    }
                    if(matchedNodeList.length > 0){
                        return matchedNodeList
                    }
                }

                var filterEdgeObj = _curEdgeList.filter(function(edge){
                    return curStartNodeIdList.indexOf(edge['from']) >= 0
                });
                var nextNodeIdList = filterEdgeObj.map(function(edge){
                    return edge['to']
                });
                
                // make list unique first to reduce the loop
                var uniqueObj = {};
                for(var i=0; i<nextNodeIdList.length; i++){
                    uniqueObj[ nextNodeIdList[i] ] = true;
                }
                nextNodeIdList = Object.keys(uniqueObj);
                var nextNodeList = nextNodeIdList.map(function(nodeId){
                    return getNodeById(nodeId, _curNodeList)
                })

                for(var i=0; i<nextNodeList.length; i++){
                    var nextNodeObj = nextNodeList[i];
                    if ( statusList.indexOf( nextNodeObj['group'] ) >= 0 ){
                        matchedNodeList.push(nextNodeObj);
                    }
                }
                if(matchedNodeList.length > 0 || nextNodeIdList.length === 0){
                    return matchedNodeList
                } else {
                    return recursiveFindStartPoint(nextNodeIdList, _curNodeList, _curEdgeList, statusList, false)
                }
            }
            function updateStartPoint(_curNodeList, _curEdgeList){
                var searchListDict = {
                    "not_sure": ['T', 'under5'],
                    "not_learned": ['X', 'not_fit'],
                }
                var startNodeIdList = getStartNode(_curNodeList, _curEdgeList);
                var startPointList = recursiveFindStartPoint(startNodeIdList, _curNodeList, _curEdgeList, searchListDict['not_learned'], true);
                if (startPointList.length === 0){
                    startPointList = recursiveFindStartPoint(startNodeIdList, _curNodeList, _curEdgeList, searchListDict['not_sure'], true);
                }
                if (startPointList.length === 0) {
                    $("#startPointText")[0].innerText = "沒有推薦的起始點。";
                } else {
                    var startPointNameList = startPointList.map(function(node){
                        return node['name'].replace('\n',' ')
                    });
                    $("#startPointText")[0].innerText = "推薦起始點為："+startPointNameList.join('、')+'。';
                }
            }

        </script>
        <script>
            var options = {
                interaction:{
                    dragNodes: true,
                },
                nodes:{
                    color:{background:'lightgrey'},
                    borderWidth: 0,
                },
                edges:{
                    arrows: 'to',
                },
                locales: {
                    jy: {
                        edit: 'Edit',
                        del: '刪除所選',
                        back: '返回',
                        addNode: '新增節點',
                        addEdge: '新增連線',
                        editNode: '點擊上面狀態修改節點狀態',
                        editEdge: '編輯連線',
                        addDescription: '在空白處按下滑鼠，新增節點。',
                        edgeDescription: '按下一個節點，並拖拉到其他節點來新增連線。',
                        editEdgeDescription: '拖移控制點來修改連線。',
                        createEdgeError: '無法新增連線。',
                        deleteClusterError: 'Clusters cannot be deleted.',
                        editClusterError: 'Clusters cannot be edited.'
                    },
                },
                locale: 'jy',
                interaction:{
                    keyboard: true,
                    multiselect: true,
                    navigationButtons: true,
                },
                manipulation:{
                    enabled: false,
                    addNode: function(nodeData, callback){
                        var name = prompt("請輸入節點名稱：", "");
                        var cg = prompt("請輸入所屬分年細目：","");
                        if (name === null || name === "" || cg === null || cg === ""){
                            alert("沒有輸入名稱，新增節點失敗。")
                            return
                        } else {
                            nodeData.id = name;
                            nodeData.cg = cg;
                            nodeData.name = name === cg ? cg : (cg + '\n' + name);
                            nodeData.label = nodeData.name;
                            callback(nodeData);
                        }
                    },
                    editNode: function(nodeData,callback) {
                        var state_word = {
                            O: "學會",
                            T: "不確定",
                            X: "不會",
                            unknown: "無資料",
                        }      
                        $("#editInfo")[0].innerText = " 將狀態從 "+state_word[nodeData.group]+
                                                      " 改變為 "+state_word[curEditGroup];
                        nodeData.group = curEditGroup;
                        callback(nodeData);
                    },
                },
                layout:{
                    randomSeed: 954201,
                    hierarchical: {
                        enabled: true,
                        edgeMinimization: true,
                        levelSeparation: 150,
                        nodeSpacing: 400,
                        blockShifting: false,
                        sortMethod: 'directed',
                    },
                },
                groups:{
                    O: {color:{background:'lawngreen'}, borderWidth: 3},
                    T: {color:{background:'yellow'}, borderWidth: 3},
                    X: {color:{background:'lightcoral'}, borderWidth: 3},
                    JY: {color:{background:'white'}, borderWidth: 3},
                    under5: {color:{background:'LightGoldenRodYellow'}, borderWidth: 3},
                    fit: {color:{background:'lightgreen'}, borderWidth: 3},
                    easy: {color:{background:'lightgreen'}, borderWidth: 3},
                    not_fit: {color:{background:'pink'}, borderWidth: 3},
                    unknown: {color:{background:'lightgrey'}, borderWidth: 0},
                    conflict: { color: { background: 'LightSkyBlue' }, borderWidth: 3 },
                },
                physics:{
                    enabled: false,
                },
            };
            var network = undefined;
            var nodeList = undefined;
            var yishengList = undefined;
            var inchaiList = undefined;
            var liveExercise = undefined;

            var curRelation = undefined;
            var curNodeList = undefined;
            var curEdgeList = undefined;
            var CgLevel = false;
            var onlyRemedialResult = false;

            var editMode = false;
            var curEditGroup = "unknown";
            // load the relation we need to use
            $(document).ready(function() {
                initialGraphElement();
            });
            function initialGraphElement(relation_path){
                var f1 = $.ajax({
                    type: "GET",
                    url: "https://dl.dropbox.com/s/kd8tyzom2hjr81r/yisheng_fraction_in_line.csv",
                    dataType: "text",
                    success: function(data) { 
                        relationList = processData(data);
                        graphElement = create_graph_element(relationList);
                        nodeList = graphElement[0];
                        yishengList = graphElement[1];
                    }
                });
                var f2 = $.ajax({
                    type: "GET",
                    url: "https://dl.dropbox.com/s/o9m8rjgo4uroara/inchai_fraction_in_line.csv",
                    dataType: "text",
                    success: function(data) { 
                        relationList = processData(data);
                        graphElement = create_graph_element(relationList);
                        inchaiList = graphElement[1];
                    }
                });
                var f3 = $.ajax({
                    type: "GET",
                    url: "https://dl.dropbox.com/s/doe733fgrptm9ap/live_exercise.csv",
                    dataType: "text",
                    success: function(data) { 
                        liveExercise = processData(data);
                    }
                });
                var f4 = $.ajax({
                    type: "GET",
                    url: "https://dl.dropbox.com/s/j9tcnyrr8b2t16b/pintong_remedial_result.txt",
                    dataType: "text",
                    success: function(data) { 
                        loadJson(data);
                    }
                });
                var f5 = $.ajax({
                    type: "GET",
                    url: "https://dl.dropbox.com/s/snfffgshh19hen3/pintong_junyi_result.txt",
                    dataType: "text",
                    success: function(data) { 
                        loadJunyiJson(data);
                    }
                });
                w = $.when(f1,f2,f3,f4,f5);
                w.done(function(){
                    curNodeList = jQuery.extend(true, [], nodeList);;
                    curEdgeList = jQuery.extend(true, [], yishengList);
                    curRelation = "宜陞";
                    initial_graph();
                    $("#dropdownNetworkButton").removeAttr("disabled");
                    $("#editModeBtn").removeAttr("disabled");
                });
            }
            function processData(allText) {
                var allTextLines = allText.split(/\r\n|\n/);
                var headers = allTextLines[0].split(',');
                var lines = [];

                for (var i=1; i<allTextLines.length; i++) {
                    var data = allTextLines[i].split(',');
                    if (data.length == headers.length) {

                        var tarr = {};
                        for (var j=0; j<headers.length; j++) {
                            tarr[headers[j]] = data[j];
                        }
                        lines.push(tarr);
                    }
                }
                return lines;
            }
            function create_graph_element( relation_list ){
                section_id_list = []
                section_list = [];
                section_edge_list = [];
                for(var i = 0; i<relation_list.length; i++){
                    relation = relation_list[i];
                    prev_chapter = relation['prev_chapter'];
                    prev_section = relation['prev_section'];
                    prev_cg = relation['prev_cg'];
                    prev_section_name = prev_chapter+'_'+prev_section;
                    section = {
                        id: prev_section_name,
                        label: prev_cg+'\n'+prev_section_name,
                        name: prev_cg+'\n'+prev_section_name,
                        cg: prev_cg,
                    }
                    if (section_id_list.indexOf(prev_section_name) === -1){
                        section_list.push(section);
                        section_id_list.push(prev_section_name);
                    }
                    next_chapter = relation['next_chapter'];
                    next_section = relation['next_section'];
                    next_cg = relation['next_cg'];
                    next_section_name = next_chapter+'_'+next_section;
                    section = {
                        id: next_section_name,
                        label: prev_cg+'\n'+next_section_name,
                        name: prev_cg+'\n'+next_section_name,
                        cg: prev_cg,
                    }
                    if (section_id_list.indexOf(next_section_name) === -1){
                        section_list.push(section);
                        section_id_list.push(next_section_name);
                    }
                    section_edge_list.push({
                        from: prev_section_name,
                        to: next_section_name,
                    })
                }
                return [section_list, section_edge_list]
            }
            function initial_graph(n_list, e_list){
                // create a network
                var container = document.getElementById('cg_network');
                
                s_nodes = new vis.DataSet(curNodeList);
                s_edges = new vis.DataSet(curEdgeList);
                
                var data = {
                    nodes: s_nodes,
                    edges: s_edges,
                };
            
                // initialize network
                network = new vis.Network(container, data, options);
                network.on("initRedraw", function () { 
                        updateStartPoint(Object.values(network.body.data.nodes._data), Object.values(network.body.data.edges._data)); 
                    });
            }
            function changeNetworkYisheng(){
                curRelation = "宜陞";
                curEdgeList = CgLevel ? cgYishengList : yishengList;
                $("#dropdownNetworkButton")[0].innerHTML = "宜陞";
                curEdgeList = changeEdgeColor({}, curEdgeList);
                setAndRedrawNetwork();
            }
            function changeNetworkInchai(){
                curRelation = "因材";
                curEdgeList = CgLevel ? cgInchaiList : inchaiList;
                $("#dropdownNetworkButton")[0].innerHTML = "因材";
                curEdgeList = changeEdgeColor({}, curEdgeList);
                setAndRedrawNetwork();
            }
            function setAndRedrawNetwork(){

                //updateStartPoint(curNodeList, curEdgeList);
                network.setData({
                    nodes: new vis.DataSet(curNodeList),
                    edges: new vis.DataSet(curEdgeList),
                });
                network.redraw();
            }
            function changeModeAndRedraw(){
                curNodeList = CgLevel ? cgNodeList : nodeList;
                switch (curRelation) {
                    case "宜陞":
                        curEdgeList = CgLevel ? cgYishengList : yishengList;
                        break;
                    case "因材":
                        curEdgeList = CgLevel ? cgInchaiList : inchaiList;
                        break;
                    default:
                        curEdgeList = CgLevel ? cgYishengList : yishengList;
                        break;
                }
                if (curEmail && !editMode) {
                    setEmail(curEmail)
                } else {
                    setAndRedrawNetwork();
                }
            }
            function changeLevel(){
                CgLevel = document.getElementById("isCgLevel").checked;
                changeModeAndRedraw();
            }
            function changeDisplayResult(){
                onlyRemedialResult = document.getElementById("onlyDisplayRemedial").checked;
                setEmail(curEmail);
            }
            function changeData(resource){
                if(resource === "custom"){
                    $("#dropdownDataButton")[0].innerHTML = "自行匯入";
                    $("#submitCustomData").show();
                    junyi_obj = {};
                    results_obj = {};
                    $("#dropdownStudentButton").attr("disabled", true);
                    $("#dropdownDateButton").attr("disabled", true);
                } else {
                    $("#dropdownDataButton")[0].innerHTML = resource === 'pintong' ? "屏東補救教學" : "歷屆補救教學";
                    $("#submitCustomData").hide();
                    var urlListDict = {
                        "pintong": ["https://dl.dropbox.com/s/j9tcnyrr8b2t16b/pintong_remedial_result.txt",
                                    "https://dl.dropbox.com/s/snfffgshh19hen3/pintong_junyi_result.txt"],
                        "past_remedial": ["https://dl.dropbox.com/s/zs8zn93oxqjkwqf/top_result.txt",
                                          "https://dl.dropbox.com/s/wpwpl7g1xyvpyrs/junyi_result.txt"],
                    };
                    updateData( urlListDict[resource] );
                }
            }
            function updateData(urlList){
                $("#dropdownStudentButton").attr("disabled", true);
                $("#dropdownNetworkButton").attr("disabled", true);
                $("#editModeBtn").attr("disabled", true);
                var remedial = $.ajax({
                    type: "GET",
                    url: urlList[0],
                    dataType: "text",
                    success: function (data) {
                        loadJson(data);
                    }
                });
                var junyi = $.ajax({
                    type: "GET",
                    url: urlList[1],
                    dataType: "text",
                    success: function (data) {
                        loadJunyiJson(data);
                    }
                });
                w = $.when(remedial, junyi);
                w.done(function () {
                    curEmail = "";
                    changeModeAndRedraw();
                    //initial_graph();
                    $("#dropdownNetworkButton").removeAttr("disabled");
                    $("#editModeBtn").removeAttr("disabled");
                });
            }

            // edit mode
            function changeEditMode(){
                editMode = !editMode;
                $("#editModeBtn")[0].innerText = editMode ? "離開編輯模式" : "進入編輯模式";
                $(".edit-mode").css("display", editMode ? "inline-block" : "none");
                $(".result-dropdown-container").css("display", !editMode ? "inline-block" : "none");
                options["manipulation"]["enabled"] = editMode;
                if(network){
                    network.setOptions(options);
                }
                changeModeAndRedraw();
            }
            function changeEditGroup(){
                choices = $.find("input[name=\"nodeGroup\"]");
                for (var i=0; i< choices.length; i++){
                    choice = choices[i];
                    if(choice.checked){
                        curEditGroup = choice.value;
                        break;
                    }
                }
            }
            function exportEditNetwork(){
                var data = network.body.data;
                var save_data = {
                    nodes: Object.values(data.nodes._data),
                    edges: Object.values(data.edges._data),
                }
                var save_txt = JSON.stringify(save_data);
                var blob = new Blob([save_txt], { type: "text/plain;charset=utf-8" });
                saveAs(blob, 'graph.txt');
            }
            function importEditNetwork(event){
                var files = document.getElementById('customNetwork').files;
                if (!files.length) {
                    alert('Please select a file!');
                    return;
                }
                var file = files[0];
                var reader = new FileReader();
                reader.readAsText(file, "UTF-8");
                reader.onload = function (e, callback) {
                    var data = reader.result;
                    data = data.replace('\n', '\\n');
                    customNetwork = jQuery.parseJSON(data);
                    curNodeList = customNetwork['nodes'];
                    curEdgeList = customNetwork['edges'];
                    setAndRedrawNetwork();
                }
            }
        </script>
    </head>
    <body>
    <div>
        <div class="dropdown">
            <button class="btn btn-primary dropdown-toggle" type="button" id="dropdownNetworkButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" disabled>
                選擇分年細目關係圖（預設宜陞）
            </button>
            <div id="networkDropdownContainer" class="dropdown-menu" aria-labelledby="dropdownNetworkButton">
                <a class="dropdown-item" value="yisheng" onclick="changeNetworkYisheng()">宜陞</a>
                <a class="dropdown-item" value="inchai" onclick="changeNetworkInchai()">因材</a>
            </div>
        </div>
        <input type="checkbox" id="isCgLevel" value="只顯示分年細目" onchange="changeLevel()"/> <span for="isCgLevel">只顯示分年細目</span>
        <input type="checkbox" id="onlyDisplayRemedial" value="只顯示補救成績" onchange="changeDisplayResult()" /> <span for="onlyDisplayRemedial">只顯示補救成績</span> <br/>
        
        <div class="dropdown">
            <button class="btn btn-primary dropdown-toggle" type="button" id="dropdownDataButton" data-toggle="dropdown" aria-haspopup="true"
                aria-expanded="false">
                選擇資料來源（預設屏東）
            </button>
            <div id="dataDropdownContainer" class="dropdown-menu" aria-labelledby="dropdownDataButton">
                <a class="dropdown-item" id="past_remedial" value="past_remedial" onclick="changeData(this.id)">歷屆補救教學</a>
                <a class="dropdown-item" id="pintong" value="pintong" onclick="changeData(this.id)">屏東補救教學</a>
                <a class="dropdown-item" id="custom" value="custom" onclick="changeData(this.id)">自行匯入</a>
            </div>
        </div>

        <span id="submitCustomData" style="display:none;">
            <input id="cg_result" type="text" name="paste the json content here" />
            <input type="submit" value="送出補救結果" onclick="loadJson()" />
            <input class="submit_junyi" id="junyi_result" type="text" style="display:none;" name="paste the json content here" />
            <input class="submit_junyi" type="submit" value="送出均一歷程" style="display:none;" onclick="loadJunyiJson()" />
            <span>格式為 { 使用者email :{ 分年細目或知識點id: {"status": ... , "data": ... }, ... }, ... }</span>
        </span>
    </div>
    <button id="editModeBtn" class="btn btn-info" onclick="changeEditMode()" disabled>進入編輯模式</button>
    <div class="edit-mode" style="display: none;">
        <button id="exportBtn" class="btn btn-success" onclick="exportEditNetwork()">匯出編輯的圖</button>
        <input id="customNetwork" type="file" name="paste the network here" onchange="importEditNetwork(event)" />
        <span class="edit-node-radio">
            <input type="radio" id="nodeGroup-unknown" name="nodeGroup" value="unknown" onchange="changeEditGroup()" checked><label for="nodeGroup-unknown"><div class="radio-color-display" style="background-color: #CCC;"></div>無資料</label>
            <input type="radio" id="nodeGroup-X" name="nodeGroup" value="X" onchange="changeEditGroup()"><label for="nodeGroup-X"><div class="radio-color-display" style="background-color: lightcoral;"></div>不會</label>
            <input type="radio" id="nodeGroup-T" name="nodeGroup" value="T" onchange="changeEditGroup()"><label for="nodeGroup-T"><div class="radio-color-display" style="background-color: yellow;"></div>不確定</label>
            <input type="radio" id="nodeGroup-O" name="nodeGroup" value="O" onchange="changeEditGroup()"><label for="nodeGroup-O"><div class="radio-color-display" style="background-color: lawnGreen;"></div>學會</label>
        </span>
        <span id="editInfo"></span>
    </div>
    <div class="result-dropdown-container">
        <span class="dropdown">
            <button class="btn btn-success dropdown-toggle" type="button" id="dropdownStudentButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" disabled>
                選擇學生
            </button>
            <div id="studentDropdownContainer" class="dropdown-menu" aria-labelledby="dropdownStudentButton">
            </div>
        </span>
        <span class="dropdown">
            <button class="btn btn-success dropdown-toggle" type="button" id="dropdownDateButton" data-toggle="dropdown" aria-haspopup="true"
                aria-expanded="false" disabled>
                選擇時間
            </button>
            <div id="dateDropdownContainer" class="dropdown-menu" aria-labelledby="dropdownDateButton">
                <a class="dropdown-item" id="all" value="all" onclick="changeNodeGroup(this.id)">所有時間</a>
            </div>
        </span>
        <span id="red_edge" style="border:1px solid red; margin-left: 10px;"></span>
    </div>
    <div class="start-point-container">
        <span id="startPointText"></span>
    </div>    
    <div id="cg_network"></div>
    </body>
    </html>

